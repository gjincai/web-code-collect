(function(t){var e=0,i=1,o=1,a=1,n="",s=!1,r=!1,c=function(){this.$btn_join=t(".btn-join"),this.$login_start=t(".login-start"),this.$login_after=t(".login-after"),this.$login_role_bind=t(".login-role-bind"),this.$login_role_change=t(".login-role-change"),this.$login_prize=t(".login-prize"),this.$login_rule=t(".login-rule"),this.$tree=t(".tree"),this.$lottery_start=t(".lottery-start"),this.$btn_share=t(".btn-share"),this.$share_qrcode=t(".share-qrcode"),this.$dialog_packet=t("#J_dialog_packet"),this.$dialog_login=t("#J_dialog_login"),this.$dialog_share=t("#J_dialog_share"),this.$dialog_my=t("#J_dialog_my"),this.$dialog_lottery=t("#J_dialog_lottery"),this.$dialog_address=t("#J_dialog_address"),this.$dialog_bind=t("#J_dialog_bind"),this.$dialog_loading=t("#J_dialog_loading"),this.$device_select=t(".device-select"),this.$service_select=t(".service-select"),this.$role_select=t(".role-select"),this.$btn_play=t(".btn-play"),this.$pop_video=t("#J_pop_video"),this.copyAcc="",this.mixAcc="",this.login_type="1",this.loot=null,this.sms_timer=null,this.isFirst=!0,this.is_ally=!1,this.pla_id="",this.srv_id="",this.role_id="",this.role_name="",this.deviceSelect=null,this.serviceSelect=null,this.roleSelect=null,this.config={project_id:"11",sdkapi_secret:"SQz7RrTGbb0j7NCK",commonapi_secret:"JZ0PJRVzpUctYExk",activity_secret:"JZ0Psf67jc10U05cykVzpUctYExk",payapi_key:"webpayqrcode",payapi_web_url:"http://test-pay.shiyue.com",sdkapi_web_url:"http://test.shiyue.com",commonapi_web_url:"http://test-common-api.shiyue.com",activityapi_url:"http://test-activity.shiyue.com",base_url:"http://test-cms-sszg.shiyue.com/m/towns.html"}};t.extend(c.prototype,{init:function(){this.initialize(),this.bindEvent(),this.copy(),this.selectArea(),this.swiperInit()},initialize:function(){var t=this,e=t.getQueryStr("token"),i=t.getQueryStr("code"),o=t.getQueryStr("copyAcc"),a=t.getQueryStr("type"),n=storage.getItem("sy_token"),s=storage.getItem("sy_acc"),r=storage.getItem("sy_mixAcc"),c=storage.getItem("sy_is_ally");null!=o&&(t.copyAcc=o,"2"==a&&(t.login_type="3")),t.$dialog_packet.show();var l={token:"",copyAcc:t.copyAcc,mixAcc:"",type:1,is_back:"",step:1};if(null!=e)t.buryLog(l),t.loginToken(e);else if(null!=i)t.buryLog(l),t.loginCode(i);else{var d=null!=s||null!=r;d?(c?(t.mixAcc=r,l.type=2,l.mixAcc=r,t.setAccInfo(r,2)):(l.token=n,l.type=1,t.setAccInfo(s.account_id,1)),t.buryLog(l)):(t.$login_start.show(),t.$login_after.hide(),t.$login_role_bind.hide(),t.$login_role_change.hide(),t.$login_prize.hide(),t.buryLog(l))}t.selectInit()},bindEvent:function(){this.$btn_join.on("click",t.proxy(this.join,this)),this.$login_start.on("click",t.proxy(this.loginPop,this)),this.$login_after.on("click",t.proxy(this.logout,this)),this.$login_prize.on("click",t.proxy(this.myPop,this)),this.$login_role_bind.on("click",t.proxy(this.bindPop,this)),this.$login_role_change.on("click",t.proxy(this.bindPop,this)),this.$lottery_start.on("click",t.proxy(this.lottery,this)),this.$btn_share.on("click",t.proxy(this.sharePop,this)),this.$dialog_login.on("click",".select-menu li",t.proxy(this.loginTab,this)),this.$dialog_login.on("click",".pic-captcha",t.proxy(this.refreshCaptcha,this)),this.$dialog_login.on("click",".login-submit",t.proxy(this.loginSubmit,this)),this.$dialog_login.on("click",".get-sms",t.proxy(this.getSms,this,this.$dialog_login,"phone_login")),this.$dialog_address.on("click",".btn-save",t.proxy(this.saveAddress,this)),this.$dialog_packet.on("click",".btn-red",t.proxy(this.redPacket,this)),this.$dialog_packet.on("click",".dialog-close",t.proxy(this.closePop,this,this.$dialog_packet)),this.$dialog_login.on("click",".dialog-close",t.proxy(this.closePop,this,this.$dialog_login)),this.$dialog_lottery.on("click",".btn-comfirm",t.proxy(this.addressPop,this)),this.$dialog_lottery.on("click",".dialog-close",t.proxy(this.closePop,this,this.$dialog_lottery)),this.$dialog_lottery.on("click",".lottery-m a",t.proxy(this.myPop,this)),this.$dialog_share.on("click",".dialog-close",t.proxy(this.closePop,this,this.$dialog_share)),this.$dialog_my.on("click",".dialog-close",t.proxy(this.closePop,this,this.$dialog_my)),this.$dialog_my.on("click",".my-add",t.proxy(this.addPop,this)),this.$dialog_my.on("click",".receive",t.proxy(this.receive,this)),this.$dialog_address.on("click",".dialog-close",t.proxy(this.closePop,this,this.$dialog_address)),this.$dialog_bind.on("click",".dialog-close",t.proxy(this.closePop,this,this.$dialog_bind)),this.$dialog_bind.on("click",".btn-comfirm",t.proxy(this.updateRole,this)),this.$tree.on("click","i",t.proxy(this.task,this)),this.$login_rule.on("click",t.proxy(this.rule,this)),this.$btn_play.on("click",t.proxy(this.videoPlay,this)),this.$pop_video.on("click",".close",t.proxy(this.videoClose,this))},getQueryStr:function(t){var e=new RegExp("(^|&)"+t+"=([^&]*)(&|$)","i"),i=window.location.search.substr(1),o=Base64.decode(i),a=o.match(e);return null!=a?decodeURIComponent(a[2]):null},isPhone:function(t){var e=/^(13[0-9]|14[579]|15[0-3,5-9]|16[6]|17[0135678]|18[0-9]|19[89])(\d{8}$)/;return!!e.test(t)},setAccInfo:function(t,e){var i=this;i.getInfo("login"),i.qrcodeInit(t,e)},join:function(e){var i=t(".lottery-tips").offset().top-t(".header").height();t("html,body").animate({scrollTop:i},700)},redPacket:function(t){var e=this,i=storage.getItem("sy_acc"),o=storage.getItem("sy_mixAcc"),a=null!=i||null!=o;a?e.join():e.loginPop(),e.$dialog_packet.hide()},loginPop:function(t){this.$dialog_login.show(),this.getCaptcha("login"),"3"==this.login_type&&(this.$dialog_login.find(".select-menu li").removeClass("cur"),this.$dialog_login.find(".select-menu li").eq(2).addClass("cur"),this.$dialog_login.find(".dialog-login").removeClass("t1 t2 t3"),this.$dialog_login.find(".dialog-login").addClass("t3"),this.$dialog_login.find(".login-box").hide(),this.$dialog_login.find(".login-box").eq(2).show())},loginTab:function(e){e=e||window.event;var i=e.currentTarget,o=t(i).index(),a=t(i).attr("data-login_type");this.login_type=a,t(i).addClass("cur").siblings().removeClass("cur"),this.$dialog_login.find(".dialog-login").removeClass("t1 t2 t3"),this.$dialog_login.find(".dialog-login").addClass("t"+a),this.$dialog_login.find(".login-box").hide(),this.$dialog_login.find(".login-box").eq(o).show()},getCaptcha:function(e){var i=this,o={};o.type=e||"login",o.ts=Math.round(new Date/1e3),o.sign=sign(o,i.config.sdkapi_secret),t.ajax({url:i.config.sdkapi_web_url+"/web/captcha",type:"post",data:o,success:function(t){0==t.code?(i.$dialog_login.find(".pic-captcha").attr("src",t.data.captcha),i.$dialog_login.find('input[name="captcha"]').val(),i.$dialog_login.find(".captcha").show()):i.$dialog_login.toast({content:"获取图片验证码失败，请稍候再试~",duration:2e3})},complete:function(t,e){200!=t.status&&i.$dialog_login.toast({content:"获取图片验证码失败，请稍候再试~",duration:2e3})}})},refreshCaptcha:function(t){this.getCaptcha("login")},countDown:function(t){var e=this,i=60;e.sms_timer=setInterval(function(){0==i?(t.text("获取验证码").removeAttr("disabled").removeClass("gray"),clearInterval(e.sms_timer)):(t.text("已发送("+i+"s)"),t.attr("disabled",!0).addClass("gray")),i--},1e3)},getSms:function(e,i){var o=this,a={},n=e.find('input[name="phone"]').val();if(""==n||!o.isPhone(n))return e.toast({content:"请输入11位手机号码~",duration:2e3}),!1;a.phone_number=n,a.sms_type=i,a.ts=Math.round(new Date/1e3),a.sign=sign(a,o.config.sdkapi_secret),o.countDown(e.find(".get-sms")),t.ajax({url:o.config.sdkapi_web_url+"/web/sms/send",type:"post",data:a,success:function(t){0==t.code?e.toast({content:"手机验证码发送成功~",duration:2e3}):(e.find(".get-sms").text("获取验证码").removeAttr("disabled").removeClass("gray"),clearInterval(o.sms_timer),e.toast({content:t.message,duration:2e3}))},complete:function(t,i){200!=t.status&&e.toast({content:"服务器出小差，请稍候再试~",duration:2e3})}})},setInfo:function(i,o){var a=this;if(a.$login_start.hide(),a.$login_after.show(),a.$login_prize.show(),"2"==i.acc_type){var n=i.role_info.server_name+"-"+i.role_info.role_name;a.$login_after.find("span").html(n)}else{var s=storage.getItem("sy_acc"),c=""==s.phone_number?s.name:s.phone_number;if(a.$login_after.find("span").html(c),"login"==o)if(null==i.role_info)a.$login_role_change.hide(),a.$login_role_bind.show(),a.bindPop();else{n=i.role_info.server_name+"-"+i.role_info.role_name;a.$login_role_change.find("span").html(n),a.$login_role_bind.hide(),a.$login_role_change.show()}}storage.setItem("sy_role_info",i.role_info),e=parseInt(i.num),r=i.isAdd,t(".lottery-num").find("span").html(i.num),"1"==i.back_status&&null!=i.role_info&&""!=a.copyAcc&&a.getBackRole(),a.isFirst?i.isFirst?(a.$dialog_packet.hide(),t("body").toast({position:"fixed",fontSize:"13px",content:"您获得了一次抽奖机会~试试你的欧气吧~",duration:2e3})):(a.$dialog_packet.hide(),t("body").toast({position:"fixed",fontSize:"13px",content:"已获得本日免费抽奖机会~ <br/>分享闪烁分享卡可获得更多机会~",duration:2e3})):a.$dialog_packet.hide()},getInfo:function(e){var i=this,o=storage.getItem("sy_token"),a=storage.getItem("sy_mixAcc"),n=storage.getItem("sy_is_ally"),s={};s.token=o,s.type=1,n&&(s.token=0,s.type=2,s.mixAcc=a),s.ts=Math.round(new Date/1e3),s.sign=sign(s,i.config.activity_secret),t.ajax({url:i.config.activityapi_url+"/towns/info",data:s,type:"post",success:function(a){0==a.code?i.setInfo(a.data,e):1003==a.code?i.refreshToken(o,t.proxy(i.getInfo,i)):(storage.removeItem("sy_acc"),storage.removeItem("sy_mixAcc"),storage.removeItem("sy_is_ally"),storage.removeItem("sy_role_info"),storage.removeItem("sy_token"))},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},refreshToken:function(e,i){var o=this,a={};a.token=e,a.ts=Math.round(new Date/1e3),a.sign=sign(a,o.config.sdkapi_secret),t.ajax({url:o.config.sdkapi_web_url+"/web/token/refresh",type:"post",data:a,success:function(t){0==t.code?(storage.setItem("sy_token",t.data.token),i&&i()):console.log(t.message)},complete:function(t,e){200!=t.status&&console.log("请求出错")}})},loginToken:function(e){var i=this,o={};o.token=e,o.ts=Math.round(new Date/1e3),o.sign=sign(o,i.config.sdkapi_secret),t.ajax({url:i.config.sdkapi_web_url+"/web/token/loginToken",data:o,type:"post",success:function(e){if(0==e.code){storage.removeItem("sy_mixAcc"),storage.removeItem("sy_is_ally"),storage.setItem("sy_acc",e.data,36e6),storage.setItem("sy_token",e.data.token);var o={token:e.data.token,copyAcc:i.copyAcc,mixAcc:i.mixAcc,type:1,is_back:"",step:2};i.buryLog(o,function(){i.setAccInfo(e.data.account_id),i.$dialog_login.hide()})}else t("body").toast({position:"fixed",content:e.message,duration:2e3})},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},loginCode:function(e){var i=this,o={};o.code=e,o.ts=Math.round(new Date/1e3),o.sign=sign(o,i.config.activity_secret),t.ajax({url:i.config.activityapi_url+"/towns/codeLogin",data:o,type:"post",success:function(e){if(0==e.code){i.mixAcc=e.data.account_id,storage.removeItem("sy_acc"),storage.removeItem("sy_token"),storage.setItem("sy_mixAcc",i.mixAcc,36e6),storage.setItem("sy_is_ally",!0);var o={token:e.data.token,copyAcc:i.copyAcc,mixAcc:i.mixAcc,type:2,is_back:"",step:2};i.buryLog(o,function(){i.setAccInfo(e.data.account_id,2),i.$dialog_login.hide()})}else t("body").toast({position:"fixed",content:e.message,duration:2e3})},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},loginWeb:function(e,i){var o=this;t.ajax({url:o.config.sdkapi_web_url+i,data:e,type:"post",success:function(t){if(0==t.code){storage.removeItem("sy_mixAcc"),storage.removeItem("sy_is_ally"),storage.setItem("sy_acc",t.data,36e6),storage.setItem("sy_token",t.data.token);var e={token:t.data.token,copyAcc:o.copyAcc,mixAcc:o.mixAcc,type:1,is_back:"",step:2};o.buryLog(e,function(){o.setAccInfo(t.data.account_id,1),o.$dialog_login.hide()})}else 1102==t.code?o.$dialog_login.toast({content:"密码输入错误，非官方账号玩家请使用游戏验证登录",duration:2e3}):o.$dialog_login.toast({content:t.message,duration:2e3})},complete:function(t,e){200!=t.status&&o.$dialog_login.toast({content:"系统繁忙，请稍候再试~",duration:2e3})}})},loginSubmit:function(t){var e=this,i="/web/login",o={},a=e.$dialog_login.find(".select-menu li.cur").attr("data-login_type");if("1"==a){if(i="/web/login",o.phone_number=e.$dialog_login.find('input[name="username"]').val(),o.password=e.$dialog_login.find('input[name="pwd"]').val(),o.code=e.$dialog_login.find('input[name="captcha"]').val(),""==o.phone_number)return e.$dialog_login.toast({content:"请输入手机号/账号~",duration:3e3}),!1;if(""==o.password)return e.$dialog_login.toast({content:"请输入密码~",duration:3e3}),!1;if(!/^[0-9a-zA-Z]{5}$/.test(o.code))return e.$dialog_login.toast({content:"请输入正确的验证码~",duration:3e3}),!1;o.ts=Math.round(new Date/1e3),o.sign=sign(o,e.config.sdkapi_secret),e.loginWeb(o,i)}else if("2"==a){if(i="/web/phoneLogin",o.phone_number=e.$dialog_login.find('input[name="phone"]').val(),o.code=e.$dialog_login.find('input[name="code"]').val(),""==o.phone_number||!e.isPhone(o.phone_number))return e.$dialog_login.toast({content:"请输入11位手机号码~",duration:2e3}),!1;if(""==o.code)return e.$dialog_login.toast({content:"请输入短信验证码~",duration:2e3}),!1;if(!/^[0-9]{4}$/.test(o.code))return e.$dialog_login.toast({content:"请输入正确短信验证码~",duration:2e3}),!1;o.ts=Math.round(new Date/1e3),o.sign=sign(o,e.config.sdkapi_secret),e.loginWeb(o,i)}else{var n=e.$dialog_login.find('input[name="gcode"]').val();if(""==n)return e.$dialog_login.toast({content:"请输入游戏验证码~",duration:2e3}),!1;e.loginCode(n)}},logout:function(t){storage.removeItem("sy_acc"),storage.removeItem("sy_mixAcc"),storage.removeItem("sy_is_ally"),storage.removeItem("sy_role_info"),storage.removeItem("sy_token"),window.location.href=this.config.base_url},lotteryIdx:function(t){var e="";switch(t){case 1:e=1;break;case 2:e=9;break;case 3:e=10;break;case 4:e=6;break;case 5:e=11;break;case 6:e=4;break;case 7:e=7;break;case 8:e=3;break;case 9:e=8;break;case 10:e=5;break;case 11:e=0;break;case 12:e=2;break;default:e=1}return e},lottery:function(r){var c=this,l=storage.getItem("sy_token"),d=storage.getItem("sy_acc"),g=storage.getItem("sy_mixAcc"),_=storage.getItem("sy_is_ally"),p=null!=d||null!=g;if(!p)return c.loginPop(),!1;if(e<=0){t("body").toast({position:"fixed",textAlign:"center",content:"抽奖次数不足~",duration:2e3});var u=t(".share-tips").offset().top-t(".header").height();return t("html,body").animate({scrollTop:u},700),!1}if(s)return!1;s=!s,api_params={},api_params.token=l,api_params.type=1,_&&(api_params.token=0,api_params.type=2,api_params.mixAcc=g),api_params.ts=Math.round(new Date/1e3),api_params.sign=sign(api_params,c.config.activity_secret),t.ajax({url:c.config.activityapi_url+"/towns/luckDraw",data:api_params,type:"post",success:function(s){0==s.code?(e=parseInt(s.data.num),i=parseInt(s.data.item_id),a=parseInt(s.data.item_type),n=s.data.item_name,o=c.lotteryIdx(i),c.lotteryStart(o,i,a,n)):1003==s.code?c.refreshToken(l,t.proxy(c.lottery,c)):t("body").toast({position:"fixed",content:s.message,duration:2e3})},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},lotteryStart:function(e,i,o,a){var n=this,r=storage.getItem("sy_token"),c=storage.getItem("sy_is_ally"),l=30,d=-l*e;t(".lottery-pan").stopRotate(),t(".lottery-pan").rotate({angle:0,animateTo:d+1800,duration:1e4,callback:function(){1==o?(n.$dialog_lottery.find(".lottery-top span").html(a),n.$dialog_lottery.find(".lottery-success2").hide(),1==e?n.$dialog_lottery.find(".lottery-mid").hide():n.$dialog_lottery.find(".lottery-mid").show(),n.$dialog_lottery.find(".lottery-success1").show()):(n.$dialog_lottery.find(".lottery-img").html('<img src="assets/zhj/images/prize/'+i+'.png" />'),n.$dialog_lottery.find(".lottery-res span").html(a),n.$dialog_lottery.find(".lottery-success1").hide(),n.$dialog_lottery.find(".lottery-success2").show()),s=!s,n.$dialog_lottery.show(),n.isFirst=!1,n.getInfo();var t={token:r,copyAcc:n.copyAcc,mixAcc:n.mixAcc,type:1,is_back:"",step:3};c&&(t.type=2),n.buryLog(t)}})},qrcodeInit:function(t,e){var i=Base64.encode("copyAcc="+t+"&type="+e),o=this.config.base_url+"?"+i;this.$share_qrcode.qrcode({width:228,height:228,text:o})},getPixelRatio:function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e},drawAndShareImage:function(t){var e=this,i=document.createElement("canvas"),o=i.getContext("2d"),a=e.getPixelRatio(o);i.width=545*a,i.height=872*a,o.fillStyle="#fff",o.rect(0,0,i.width,i.height);var n=Math.floor(7*Math.random()+1),s=new Image;s.src="./assets/zhj/images/share/"+n+".jpg",s.crossOrigin="Anonymous",s.onload=function(){o.drawImage(s,0,0,545*a,872*a);var n=new Image;n.src=t,n.crossOrigin="Anonymous",n.onload=function(){o.fillStyle="#fff",o.rect(0,0,i.width,i.height),o.drawImage(n,365*a,672*a,150*a,150*a);var t=i.toDataURL("image/jpeg");e.$dialog_share.find(".share-card .download").attr("href",t),e.$dialog_share.find(".share-card img").attr("src",t),e.$dialog_loading.hide(),e.$dialog_share.show()}}},sharePop:function(t){var e=this,i=storage.getItem("sy_token"),o=storage.getItem("sy_acc"),a=storage.getItem("sy_mixAcc"),n=storage.getItem("sy_is_ally"),s=null!=o||null!=a;if(!s)return e.loginPop(),!1;var r={token:i,copyAcc:e.copyAcc,mixAcc:"",type:1,is_back:"",step:4};n&&(r.type=2,r.mixAcc=a),e.buryLog(r,function(){e.isFirst=!1,e.getInfo()}),e.$dialog_loading.show();var c=this.$share_qrcode.find("canvas")[0].toDataURL();this.drawAndShareImage(c)},bindPop:function(){var t=this;t.getPlatforms(t.config.project_id),t.$dialog_bind.show()},selectInit:function(){var t=this;t.deviceSelect=new MobileSelect({trigger:".device-select",title:"请选择平台",wheels:[{data:[{id:"",name:"暂无平台"}]}],keyMap:{id:"id",value:"name"},callback:function(e,i){if(t.srv_id="",t.$service_select.html("<span>请选择区服</span>"),t.role_id="",t.role_name="",t.$role_select.html("<span>请选择角色</span>"),t.pla_id=i[0].id||"",""==t.pla_id)return!1;t.getServers(t.pla_id)}}),t.serviceSelect=new MobileSelect({trigger:".service-select",title:"请选择区服",wheels:[{data:[{server_id:"",server_name:"暂无区服"}]}],keyMap:{id:"server_id",value:"server_name"},callback:function(e,i){if(t.role_id="",t.role_name="",t.$role_select.html("<span>请选择角色</span>"),t.srv_id=i[0].server_id||"",""==t.srv_id)return!1;t.getRole(t.srv_id)}}),t.roleSelect=new MobileSelect({trigger:".role-select",title:"请选择角色",wheels:[{data:[{role_id:"",role_name:"暂无角色"}]}],keyMap:{id:"role_id",value:"role_name"},callback:function(e,i){t.role_id=i[0].role_id,t.role_name=i[0].role_name}})},getPlatforms:function(e){var i=this,o={};o.project_id=e,o.ts=Math.round(new Date/1e3),o.sign=sign(o,i.config.payapi_key),t.ajax({url:i.config.payapi_web_url+"/webPay/platforms",type:"post",data:o,success:function(e){0==e.code&&0!=e.data.length?i.deviceSelect.updateWheel(0,e.data):t("body").toast({position:"fixed",content:"获取平台失败，请稍候再试~",duration:2e3})},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},getServers:function(e){var i=this,o=storage.getItem("sy_acc");if(api_params={},null==o)return i.loginPop(),!1;api_params.name=o.name,api_params.project_id=i.config.project_id,api_params.platform=e,api_params.ts=Math.round(new Date/1e3),api_params.sign=sign(api_params,i.config.commonapi_secret),t.ajax({url:i.config.commonapi_web_url+"/project/getOwnServers",type:"post",data:api_params,success:function(e){0==e.code?0!=e.data.length?i.serviceSelect.updateWheel(0,e.data):t("body").toast({position:"fixed",content:"暂无玩过的区服，请重新选择",duration:2e3}):t("body").toast({position:"fixed",content:"获取区服失败，请稍候再试~",duration:2e3})},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},getRole:function(e){var i=this,o=storage.getItem("sy_token");acc=storage.getItem("sy_acc"),api_params={},api_params.project_id=i.config.project_id,api_params.server_id=e,api_params.name=acc.name,api_params.token=o,api_params.ts=Math.round(new Date/1e3),api_params.sign=sign(api_params,i.config.commonapi_secret),t.ajax({url:i.config.commonapi_web_url+"/project/getRole",type:"post",data:api_params,success:function(a){0==a.code&&0!=a.data.length?i.roleSelect.updateWheel(0,a.data):1003==a.code?i.refreshToken(o,t.proxy(i.getRole,i,e)):t("body").toast({position:"fixed",content:"获取角色失败，请重新选择",duration:2e3})},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},bindRole:function(e){var i=this,o=storage.getItem("sy_token"),a=storage.getItem("sy_mixAcc"),n=storage.getItem("sy_is_ally"),s={};s.token=o,s.type=1,n&&(s.token=0,s.type=2,s.mixAcc=a),s.zone_id=e.zone_id,s.platform=e.platform,s.server_name=e.server_name,s.role_id=e.role_id,s.role_name=e.role_name,s.ts=Math.round(new Date/1e3),s.sign=sign(s,i.config.activity_secret),t.ajax({url:i.config.activityapi_url+"/towns/editRole",data:s,type:"post",success:function(e){0==e.code?(i.isFirst=!1,i.getInfo(),i.$dialog_bind.hide()):1003==e.code?i.refreshToken(o,t.proxy(i.bindRole,i)):t("body").toast({position:"fixed",textAlign:"center",content:e.message,duration:2e3})},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",textAlign:"center",content:"系统繁忙，请稍候再试~",duration:2e3})}})},getBackRole:function(){var e=this,i=storage.getItem("sy_acc"),o=storage.getItem("sy_mixAcc"),a={};a.copyAcc=e.copyAcc,null!=i?a.account_id=i.account_id:null!=o&&(a.account_id=o),a.ts=Math.round(new Date/1e3),a.sign=sign(a,e.config.activity_secret),t.ajax({url:e.config.activityapi_url+"/towns/backNo",data:a,type:"post",success:function(t){0==t.code&&e.backRole(t.data)},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},backRole:function(e){var i=this,o=storage.getItem("sy_token"),a=storage.getItem("sy_acc"),n=storage.getItem("sy_mixAcc"),s=storage.getItem("sy_role_info"),r={};r.role_id=s.role_id,r.platform=s.platform,r.zone_id=s.zone_id,null!=a?r.account_id=a.account_id:null!=n&&(r.account_id=n),r.back_acc=e.back_acc,r.back_no=e.back_card,r.ctime=e.ctime,r.flag=e.flag,r.ts=Math.round(new Date/1e3),r.sign=sign(r,i.config.activity_secret),t.ajax({url:"https://weekly-sszg.shiyuegame.com/api.php/pf/towns/back",data:r,type:"get",success:function(t){var e=JSON.parse(t);if(666==e.error){var a={token:o,copyAcc:i.copyAcc,mixAcc:n,type:1,is_back:"",step:5};null!=n&&(a.type=2),i.buryLog(a)}},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},updateRole:function(){var e=this,i=storage.getItem("sy_token"),o=storage.getItem("sy_mixAcc"),a=storage.getItem("sy_is_ally"),n={};if(n.token=i,n.type=1,a&&(n.token=0,n.type=2,n.mixAcc=o),""==e.pla_id)return e.$dialog_bind.toast({position:"fixed",textAlign:"center",content:"请选择您的平台~",duration:2e3}),!1;if(""==e.srv_id)return e.$dialog_bind.toast({position:"fixed",textAlign:"center",content:"请选择您的区服~",duration:2e3}),!1;if(""==e.role_id)return e.$dialog_bind.toast({position:"fixed",textAlign:"center",content:"请选择您的角色~",duration:2e3}),!1;var s=e.serviceSelect.getValue(),r=s[0].server_id.split("_");n.platform=r[0],n.zone_id=r[1],n.server_name=s[0].server_name;var c=e.roleSelect.getValue();n.role_id=c[0].role_id,n.role_name=c[0].role_name,n.ts=Math.round(new Date/1e3),n.sign=sign(n,e.config.activity_secret),t.ajax({url:e.config.activityapi_url+"/towns/editRole",data:n,type:"post",success:function(o){0==o.code?(t("body").toast({position:"fixed",textAlign:"center",content:"角色绑定成功~",duration:2e3}),e.isFirst=!1,e.getInfo("login"),e.$dialog_bind.hide()):1003==o.code?e.refreshToken(i,t.proxy(e.updateRole,e)):t("body").toast({position:"fixed",textAlign:"center",content:o.message,duration:2e3})},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",textAlign:"center",content:"系统繁忙，请稍候再试~",duration:2e3})}})},addressPop:function(t){this.$dialog_lottery.hide(),r&&2==a?this.$dialog_address.show():this.$dialog_address.hide()},addPop:function(e){this.$dialog_my.hide();var i=this,o=storage.getItem("sy_token"),a=storage.getItem("sy_mixAcc"),n=storage.getItem("sy_is_ally"),s={};s.token=o,s.type=1,n&&(s.token=0,s.type=2,s.mixAcc=a),s.ts=Math.round(new Date/1e3),s.sign=sign(s,i.config.activity_secret),t.ajax({url:i.config.activityapi_url+"/towns/info",data:s,type:"post",success:function(e){0==e.code?(e.data.isAdd?(i.$dialog_address.find('input[name="name"]').val(""),i.$dialog_address.find('input[name="phone"]').val(""),i.$dialog_address.find(".area").html("<span>请选择地区</span>"),i.$dialog_address.find('input[name="address"]').val(""),i.$dialog_address.find(".area").show(),i.$dialog_address.find(".btn-save").show()):(i.$dialog_address.find('input[name="name"]').val(e.data.name),i.$dialog_address.find('input[name="phone"]').val(e.data.contact),i.$dialog_address.find('input[name="address"]').val(e.data.address),i.$dialog_address.find(".area").hide(),i.$dialog_address.find(".btn-save").hide()),i.$dialog_address.show()):1003==e.code?i.refreshToken(o,t.proxy(i.getInfo,i)):(i.$dialog_address.find('input[name="name"]').val(""),i.$dialog_address.find('input[name="phone"]').val(""),i.$dialog_address.find(".area").html("<span>请选择地区</span>"),i.$dialog_address.find('input[name="address"]').val(""),i.$dialog_address.find(".area").show(),i.$dialog_address.find(".btn-save").show(),i.$dialog_address.show())},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},selectArea:function(){new MobileSelect({trigger:"#triggerCity",title:"地区选择",wheels:[{data:cityData}],callback:function(t,e){console.log(e)}})},saveAddress:function(e){var i=this,o=storage.getItem("sy_token"),a=storage.getItem("sy_mixAcc"),n=storage.getItem("sy_is_ally"),s={};return s.token=o,s.type=1,n&&(s.token=0,s.type=2,s.mixAcc=a),s.name=i.$dialog_address.find('input[name="name"]').val(),s.contact=i.$dialog_address.find('input[name="phone"]').val(),s.city=i.$dialog_address.find(".area").html(),s.address=i.$dialog_address.find('input[name="address"]').val(),""==s.name?(i.$dialog_address.toast({textAlign:"center",content:"请输入真实姓名~",duration:2e3}),!1):""!=s.contact&&i.isPhone(s.contact)?"<span>请选择地区</span>"==s.city?(i.$dialog_address.toast({textAlign:"center",content:"请选择地区~",duration:2e3}),!1):""==s.address?(i.$dialog_address.toast({textAlign:"center",content:"请输入详细地址~",duration:2e3}),!1):(s.ts=Math.round(new Date/1e3),s.sign=sign(s,i.config.activity_secret),void t.ajax({url:i.config.activityapi_url+"/towns/editInfo",data:s,type:"post",success:function(e){0==e.code?(i.$dialog_address.toast({textAlign:"center",content:"收获地址修改成功~",duration:2e3}),i.isFirst=!1,i.getInfo(),i.$dialog_address.hide()):1003==e.code?i.refreshToken(o,t.proxy(i.saveAddress,i)):i.$dialog_address.toast({content:e.message,duration:2e3})},complete:function(t,e){200!=t.status&&i.$dialog_address.toast({content:"系统繁忙，请稍候再试~",duration:2e3})}})):(i.$dialog_address.toast({textAlign:"center",content:"请输入11位手机号码~",duration:2e3}),!1)},receive:function(e){e=e||window.event;var i=e.currentTarget,o=this,a={},n=t(i).hasClass("is_receive"),s=storage.getItem("sy_role_info");if(n)return!1;if(!s)return o.$dialog_my.hide(),o.bindPop(),t("body").toast({position:"fixed",textAlign:"center",content:"请先完成角色绑定~",duration:2e3}),!1;var r=s.role_id,c=s.platform,l=s.zone_id,d=t(i).attr("data-account_id"),g=t(i).attr("data-card_id"),_=t(i).attr("data-card_no"),p=t(i).attr("data-ctime"),u=t(i).attr("data-flag");a.role_id=r,a.platform=c,a.zone_id=l,a.account_id=d,a.card_id=g,a.card_no=_,a.ctime=p,a.flag=u,a.ts=Math.round(new Date/1e3),a.sign=sign(a,o.config.activity_secret),t.ajax({url:"https://weekly-sszg.shiyuegame.com/api.php/pf/towns/gift",data:a,type:"get",success:function(e){var a=JSON.parse(e);if(666==a.error){t("body").toast({position:"fixed",textAlign:"center",content:"领取成功，预计24小时内发到绑定角色上~",duration:2e3});var n="已发给"+s.server_name+"-"+s.role_name;t(i).html(n),t(i).addClass("is_receive"),o.editGift(_)}else t("body").toast({position:"fixed",textAlign:"center",content:a.msg,duration:2e3})},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},editGift:function(e){var i=this,o=storage.getItem("sy_token"),a=storage.getItem("sy_mixAcc"),n=storage.getItem("sy_is_ally"),s=storage.getItem("sy_role_info"),r={};r.token=o,r.type=1,n&&(r.token=0,r.type=2,r.mixAcc=a),r.card_no=e,r.role_name=s.role_name,r.server_name=s.server_name,r.role_id=s.role_id,r.platform=s.platform,r.zone_id=s.zone_id,r.ts=Math.round(new Date/1e3),r.sign=sign(r,i.config.activity_secret),t.ajax({url:i.config.activityapi_url+"/towns/editGift",data:r,type:"post",success:function(t){},complete:function(e,i){200!=e.status&&t("body").toast({position:"fixed",content:"系统繁忙，请稍候再试~",duration:2e3})}})},timeDuring:function(t){var e=new Date(1e3*t),i=e.getFullYear()+"-",o=(e.getMonth()+1<10?"0"+(e.getMonth()+1):e.getMonth()+1)+"-",a=e.getDate()<10?"0"+e.getDate():e.getDate();return i+o+a},renderMy:function(t){var e=this,i="",o="<li>";o+='<div class="e1">奖品名称</div>',o+='<div class="e2">获取时间</div>',o+='<div class="e3">奖品内容</div>',o+="</li>";for(var a=0,n=t.length;a<n;a++)i=t[a].time.split(" ")[0],o+="<li>",o+='<div class="e1">'+t[a].name+"</div>",o+='<div class="e2">'+i+"</div>","再来一次"==t[a].name||2==parseInt(t[a].item_type)?o+='<div class="e3"></div>':null!=t[a].role_info?o+='<div class="e3">已发给'+t[a].role_info.server_name+"-"+t[a].role_info.role_name+"</div>":(o+='<div class="e3 receive" data-account_id = "'+t[a].account_id+'" data-card_id="'+t[a].card_id+'" data-card_no="'+t[a].card_no+'" data-ctime="'+t[a].ctime+'" data-flag="'+t[a].flag+'"><a href="javascript:;">领取</a></div>',o+="</li>");e.$dialog_my.find(".my-box").html(o),e.$dialog_my.show()},myPop:function(e){this.$dialog_lottery.hide();var i=this,o=storage.getItem("sy_token"),a=storage.getItem("sy_mixAcc"),n=storage.getItem("sy_is_ally"),s={};s.token=o,s.type=1,n&&(s.token=0,s.type=2,s.mixAcc=a),s.ts=Math.round(new Date/1e3),s.sign=sign(s,i.config.activity_secret),t.ajax({url:i.config.activityapi_url+"/towns/optInfo",data:s,type:"post",success:function(e){0==e.code&&0!=e.data.length?i.renderMy(e.data):1003==e.code?i.refreshToken(o,t.proxy(i.myPop,i)):(i.$dialog_my.find(".my-box").html("暂无记录~"),i.$dialog_my.show())},complete:function(t,e){200!=t.status&&i.$dialog_my.toast({content:"系统繁忙，请稍候再试~",duration:2e3})}})},closePop:function(t){t.hide()},buryLog:function(e,i){var o=this,a={};a.token=e.token||"",a.copyAcc=e.copyAcc||"",a.mixAcc=e.mixAcc||"",a.type=e.type||"1",a.is_back=e.is_back||"",a.step=e.step,a.ts=Math.round(new Date/1e3),a.sign=sign(a,o.config.activity_secret),t.ajax({url:o.config.activityapi_url+"/towns/log",data:a,type:"post",success:function(t){0==t.code&&i&&i(t.data)},complete:function(t,e){200!=t.status&&console.log("埋点请求出错")}})},copy:function(){var e=new ClipboardJS(".copy");e.on("success",function(e){t("body").toast({position:"fixed",textAlign:"center",content:"复制成功~",duration:2e3})}),e.on("error",function(e){t("body").toast({position:"fixed",textAlign:"center",content:"复制失败~",duration:2e3}),console.log(e)})},swiperInit:function(){new Swiper(".gift-swiper",{autoplay:!0,loop:!0,centeredSlides:!0,slidesPerView:3,navigation:{nextEl:".gift-next",prevEl:".gift-prev"},pagination:{el:".swiper-pagination-gift",clickable:!0}}),new Swiper(".feature-swiper",{pagination:{el:".swiper-pagination-feature",clickable:!0},parallax:!0,loop:!0,speed:300,centeredSlides:!0,slidesPerView:"auto",autoplay:{disableOnInteraction:!1,delay:3e3},effect:"coverflow",coverflowEffect:{rotate:0,stretch:254,depth:200,modifier:1,slideShadows:!0}})},task:function(e){var i=t(".page4 .title").offset().top-t(".header").height();t("html,body").animate({scrollTop:i},700)},rule:function(e){var i=t(".page5 .top").offset().top-t(".header").height();t("html,body").animate({scrollTop:i},700)},videoPlay:function(e){e=e||window.event
;var i=e.currentTarget,o=this,a=null,n=t(i).attr("data-poster"),s=t(i).attr("data-video");clearTimeout(a),o.$pop_video.find("video").attr({poster:n,src:s}),a=setTimeout(function(){o.$pop_video.find("video")[0].currentTime=0,o.$pop_video.find("video")[0].play()},100),o.$pop_video.show()},videoClose:function(t){this.$pop_video.hide(),this.$pop_video.find("video")[0].pause()}}),t(document).ready(function(){(new c).init()})})(jQuery);